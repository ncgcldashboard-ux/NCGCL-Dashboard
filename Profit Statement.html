import React, { useState, useMemo, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area } from 'recharts';
import { Calculator, TrendingUp, DollarSign, Percent, ArrowRight, Info, AlertCircle } from 'lucide-react';

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>
    {children}
  </div>
);

const StatCard = ({ title, value, subvalue, icon: Icon, colorClass }) => (
  <Card className="p-6">
    <div className="flex items-start justify-between">
      <div>
        <p className="text-sm font-medium text-slate-500 mb-1">{title}</p>
        <h3 className="text-2xl font-bold text-slate-900">{value}</h3>
        {subvalue && <p className={`text-sm mt-1 ${colorClass}`}>{subvalue}</p>}
      </div>
      <div className={`p-3 rounded-lg ${colorClass} bg-opacity-10`}>
        <Icon size={24} className={colorClass.replace('text-', 'text-')} />
      </div>
    </div>
  </Card>
);

const InputGroup = ({ label, value, onChange, prefix = "", suffix = "", step = "0.1", min = "0" }) => (
  <div className="mb-4">
    <label className="block text-sm font-medium text-slate-700 mb-1">{label}</label>
    <div className="relative rounded-md shadow-sm">
      {prefix && (
        <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
          <span className="text-slate-500 sm:text-sm">{prefix}</span>
        </div>
      )}
      <input
        type="number"
        value={value}
        onChange={(e) => {
          const val = parseFloat(e.target.value);
          onChange(isNaN(val) ? 0 : val);
        }}
        onFocus={(e) => e.target.select()}
        className={`block w-full rounded-md border-slate-300 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border pl-3 ${prefix ? 'pl-7' : ''} ${suffix ? 'pr-12' : ''}`}
        placeholder="0.00"
        step={step}
        min={min}
      />
      {suffix && (
        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
          <span className="text-slate-500 sm:text-sm">{suffix}</span>
        </div>
      )}
    </div>
  </div>
);

const App = () => {
  // Initial State based on the provided CSV snippet
  const [inputs, setInputs] = useState({
    principal: 1000000000,
    durationMonths: 12,
    bankRate: 10,
    mfRate: 10, // Assuming similar rate for direct comparison of tax impact
    bankTaxRate: 29, // 29% from snippet
    mfTaxRate: 15, // 15% from snippet (CGT)
    superTaxRate: 10, // 10% from snippet
  });

  // Calculate Projection
  const data = useMemo(() => {
    // Safety check for critical inputs to prevent calculation errors if 0
    const safePrincipal = inputs.principal || 0;
    
    let bankBalance = safePrincipal;
    let mfBalance = safePrincipal;
    const chartData = [];

    // Monthly Logic
    for (let month = 0; month <= inputs.durationMonths; month++) {
      if (month === 0) {
        chartData.push({
          month,
          name: 'Start',
          Bank: Math.round(bankBalance),
          MutualFund: Math.round(mfBalance),
          BankGain: 0,
          MFGain: 0,
        });
        continue;
      }

      // Bank Calculation: Interest is taxed monthly (WHT)
      const bankMonthlyRate = inputs.bankRate / 100 / 12;
      const bankInterest = bankBalance * bankMonthlyRate;
      const bankTax = bankInterest * (inputs.bankTaxRate / 100);
      bankBalance = bankBalance + bankInterest - bankTax;

      // MF Calculation: Gross compounding (Tax deferred until end)
      // Note: Some funds have daily accrual, we simulate monthly compounding of gross return
      const mfMonthlyRate = inputs.mfRate / 100 / 12;
      const mfGain = mfBalance * mfMonthlyRate;
      mfBalance = mfBalance + mfGain;

      chartData.push({
        month,
        name: `M${month}`,
        Bank: Math.round(bankBalance),
        MutualFund: Math.round(mfBalance),
        BankGain: Math.round(bankBalance - safePrincipal),
        MFGain: Math.round(mfBalance - safePrincipal),
      });
    }

    return { chartData, finalBank: bankBalance, finalMF: mfBalance };
  }, [inputs]);

  // Final Adjustments (Super Tax & Deferred Tax)
  const results = useMemo(() => {
    const safePrincipal = inputs.principal || 0;
    const totalBankGain = data.finalBank - safePrincipal;
    const totalMFGainGross = data.finalMF - safePrincipal;

    // Bank Super Tax
    // Snippet shows Super Tax deducted at the end based on gain
    const bankSuperTax = totalBankGain * (inputs.superTaxRate / 100);
    const bankNetFinish = data.finalBank - bankSuperTax;

    // MF Taxes
    // MF usually pays CGT at the end + Super Tax
    const mfTax = totalMFGainGross * (inputs.mfTaxRate / 100);
    const mfSuperTax = totalMFGainGross * (inputs.superTaxRate / 100);
    const mfNetFinish = data.finalMF - mfTax - mfSuperTax;

    // Avoid division by zero for display logic
    const bankTaxDenominator = 1 - inputs.bankTaxRate/100;
    const bankGrossEquivalent = bankTaxDenominator !== 0 ? (totalBankGain / bankTaxDenominator) : 0;
    const bankMonthlyTaxPaid = bankGrossEquivalent - totalBankGain;

    return {
      bank: {
        gross: data.finalBank,
        gain: totalBankGain,
        superTax: bankSuperTax,
        net: bankNetFinish,
        totalTax: (data.finalBank - bankNetFinish) + bankMonthlyTaxPaid,
        monthlyTaxPaid: bankMonthlyTaxPaid,
        grossInterest: bankGrossEquivalent
      },
      mf: {
        gross: data.finalMF,
        gain: totalMFGainGross,
        tax: mfTax,
        superTax: mfSuperTax,
        net: mfNetFinish
      }
    };
  }, [data, inputs]);

  const formatCurrency = (val) => {
    if (val === 0) return "0";
    if (val >= 1000000000) return `${(val / 1000000000).toFixed(2)}B`;
    if (val >= 1000000) return `${(val / 1000000).toFixed(2)}M`;
    return val.toLocaleString();
  };

  const formatNumber = (num) => {
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(num);
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900">
      <div className="max-w-7xl mx-auto space-y-6">
        
        {/* Header */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
              <TrendingUp className="text-indigo-600" />
              Compounding Growth Analyzer
            </h1>
            <p className="text-slate-600 mt-1">Comparing Bank Deposits vs. Mutual Funds tax efficiency</p>
          </div>
          <div className="flex items-center gap-2 text-sm text-slate-500 bg-white px-4 py-2 rounded-full shadow-sm border border-slate-200">
            <Info size={16} />
            <span>Scenario: {inputs.durationMonths} Month Investment Term</span>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
          
          {/* Controls Sidebar */}
          <div className="lg:col-span-3 space-y-6">
            <Card className="p-5">
              <h3 className="font-semibold text-slate-900 mb-4 flex items-center gap-2">
                <Calculator size={18} /> Configuration
              </h3>
              
              <InputGroup 
                label="Principal Amount" 
                value={inputs.principal} 
                onChange={v => setInputs({...inputs, principal: v})} 
                min="1000"
                step="10000"
              />
              <InputGroup 
                label="Duration (Months)" 
                value={inputs.durationMonths} 
                onChange={v => setInputs({...inputs, durationMonths: v})} 
                min="1"
                step="1"
                suffix="mo"
              />

              <div className="border-t border-slate-100 my-4 pt-4">
                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Bank Parameters</h4>
                <InputGroup 
                  label="Annual Rate" 
                  value={inputs.bankRate} 
                  onChange={v => setInputs({...inputs, bankRate: v})} 
                  suffix="%"
                />
                <InputGroup 
                  label="WHT (Monthly Tax)" 
                  value={inputs.bankTaxRate} 
                  onChange={v => setInputs({...inputs, bankTaxRate: v})} 
                  suffix="%"
                />
              </div>

              <div className="border-t border-slate-100 my-4 pt-4">
                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Mutual Fund Parameters</h4>
                <InputGroup 
                  label="Annual Rate" 
                  value={inputs.mfRate} 
                  onChange={v => setInputs({...inputs, mfRate: v})} 
                  suffix="%"
                />
                <InputGroup 
                  label="CGT (End of Term)" 
                  value={inputs.mfTaxRate} 
                  onChange={v => setInputs({...inputs, mfTaxRate: v})} 
                  suffix="%"
                />
              </div>

               <div className="border-t border-slate-100 my-4 pt-4">
                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Global Taxes</h4>
                <InputGroup 
                  label="Super Tax (on Gain)" 
                  value={inputs.superTaxRate} 
                  onChange={v => setInputs({...inputs, superTaxRate: v})} 
                  suffix="%"
                />
              </div>
            </Card>

            <div className="bg-indigo-50 rounded-xl p-4 border border-indigo-100">
                <div className="flex gap-2 items-start text-indigo-800">
                    <AlertCircle size={18} className="mt-0.5 shrink-0" />
                    <p className="text-xs leading-relaxed">
                        <strong>Insight:</strong> Bank deposits typically deduct tax monthly, reducing the principal available for compounding. Mutual funds often defer tax until redemption, allowing gross amounts to compound longer.
                    </p>
                </div>
            </div>
          </div>

          {/* Main Content */}
          <div className="lg:col-span-9 space-y-6">
            
            {/* Stats Row */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <StatCard 
                title="Bank Net Profit" 
                value={formatCurrency(results.bank.net - inputs.principal)} 
                subvalue={`${inputs.principal > 0 ? ((results.bank.net - inputs.principal)/inputs.principal * 100).toFixed(2) : 0}% Return`}
                icon={DollarSign}
                colorClass="text-slate-600"
              />
              <StatCard 
                title="Mutual Fund Net Profit" 
                value={formatCurrency(results.mf.net - inputs.principal)} 
                subvalue={`${inputs.principal > 0 ? ((results.mf.net - inputs.principal)/inputs.principal * 100).toFixed(2) : 0}% Return`}
                icon={TrendingUp}
                colorClass="text-emerald-600"
              />
              <StatCard 
                title="Difference" 
                value={formatCurrency(results.mf.net - results.bank.net)} 
                subvalue="Additional Gain"
                icon={ArrowRight}
                colorClass="text-indigo-600"
              />
            </div>

            {/* Chart Area */}
            <Card className="p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="font-bold text-slate-800">Portfolio Growth Trajectory</h3>
                <div className="flex gap-4 text-sm">
                   <div className="flex items-center gap-2">
                     <span className="w-3 h-3 rounded-full bg-slate-400"></span>
                     <span>Bank Deposit</span>
                   </div>
                   <div className="flex items-center gap-2">
                     <span className="w-3 h-3 rounded-full bg-emerald-500"></span>
                     <span>Mutual Fund</span>
                   </div>
                </div>
              </div>
              
              <div className="h-[400px] w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <AreaChart data={data.chartData} margin={{ top: 10, right: 30, left: 20, bottom: 0 }}>
                    <defs>
                      <linearGradient id="colorBank" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#94a3b8" stopOpacity={0.1}/>
                        <stop offset="95%" stopColor="#94a3b8" stopOpacity={0}/>
                      </linearGradient>
                      <linearGradient id="colorMF" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#10b981" stopOpacity={0.1}/>
                        <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                    <XAxis 
                        dataKey="name" 
                        axisLine={false} 
                        tickLine={false} 
                        tick={{fill: '#64748b', fontSize: 12}}
                        dy={10}
                    />
                    <YAxis 
                        domain={['dataMin', 'dataMax']} 
                        axisLine={false} 
                        tickLine={false}
                        tick={{fill: '#64748b', fontSize: 12}}
                        tickFormatter={(val) => `${(val/1000000).toFixed(1)}M`}
                        dx={-10}
                    />
                    <Tooltip 
                        contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}}
                        formatter={(value) => [formatNumber(value), '']}
                        labelStyle={{color: '#64748b', marginBottom: '0.5rem'}}
                    />
                    <Area 
                        type="monotone" 
                        dataKey="Bank" 
                        stroke="#94a3b8" 
                        strokeWidth={2}
                        fillOpacity={1} 
                        fill="url(#colorBank)" 
                        name="Bank Deposit"
                    />
                    <Area 
                        type="monotone" 
                        dataKey="MutualFund" 
                        stroke="#10b981" 
                        strokeWidth={2}
                        fillOpacity={1} 
                        fill="url(#colorMF)" 
                        name="Mutual Fund"
                    />
                  </AreaChart>
                </ResponsiveContainer>
              </div>
            </Card>

            {/* Detailed Breakdown Table */}
             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Card className="p-0 overflow-hidden">
                    <div className="bg-slate-50 p-4 border-b border-slate-200">
                        <h4 className="font-semibold text-slate-700">Bank Breakdown</h4>
                    </div>
                    <div className="p-4 space-y-3">
                        <div className="flex justify-between text-sm">
                            <span className="text-slate-500">Gross Interest Earned</span>
                            <span className="font-medium">{formatNumber(results.bank.grossInterest)}</span>
                        </div>
                         <div className="flex justify-between text-sm">
                            <span className="text-slate-500">Monthly Tax Deducted (Approx)</span>
                            <span className="text-red-500">-{formatNumber(results.bank.monthlyTaxPaid)}</span>
                        </div>
                         <div className="flex justify-between text-sm border-t border-slate-100 pt-2">
                            <span className="text-slate-500">Net Before Super Tax</span>
                            <span className="font-medium">{formatNumber(results.bank.gain)}</span>
                        </div>
                        <div className="flex justify-between text-sm">
                            <span className="text-slate-500">Super Tax ({inputs.superTaxRate}%)</span>
                            <span className="text-red-500">-{formatNumber(results.bank.superTax)}</span>
                        </div>
                        <div className="flex justify-between text-base font-bold bg-slate-50 p-2 rounded border border-slate-100">
                            <span className="text-slate-700">Net Profit</span>
                            <span className="text-slate-900">{formatNumber(results.bank.net - inputs.principal)}</span>
                        </div>
                    </div>
                </Card>

                <Card className="p-0 overflow-hidden">
                    <div className="bg-emerald-50 p-4 border-b border-emerald-100">
                        <h4 className="font-semibold text-emerald-800">Mutual Fund Breakdown</h4>
                    </div>
                    <div className="p-4 space-y-3">
                        <div className="flex justify-between text-sm">
                            <span className="text-slate-500">Gross Gain</span>
                            <span className="font-medium">{formatNumber(results.mf.gain)}</span>
                        </div>
                         <div className="flex justify-between text-sm">
                            <span className="text-slate-500">Tax Deferred Compounding</span>
                            <span className="text-emerald-600 font-medium">Active</span>
                        </div>
                         <div className="flex justify-between text-sm border-t border-slate-100 pt-2">
                            <span className="text-slate-500">Capital Gains Tax ({inputs.mfTaxRate}%)</span>
                            <span className="text-red-500">-{formatNumber(results.mf.tax)}</span>
                        </div>
                        <div className="flex justify-between text-sm">
                            <span className="text-slate-500">Super Tax ({inputs.superTaxRate}%)</span>
                            <span className="text-red-500">-{formatNumber(results.mf.superTax)}</span>
                        </div>
                        <div className="flex justify-between text-base font-bold bg-slate-50 p-2 rounded border border-slate-100">
                            <span className="text-slate-700">Net Profit</span>
                            <span className="text-emerald-700">{formatNumber(results.mf.net - inputs.principal)}</span>
                        </div>
                    </div>
                </Card>
             </div>

          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
